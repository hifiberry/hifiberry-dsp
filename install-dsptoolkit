#!/bin/sh
sudo apt update
for p in python3-pip libasound2-dev libxslt1-dev libxml2-dev zlib1g-dev libxml2-dev libxslt-dev python3-dev git gcc alsa-utils; do
 sudo apt install -y $p
done

cd
git clone https://github.com/hifiberry/hifiberry-dsp
cd hifiberry-dsp

# Stop existing services
for i in sigmatcp sigmatcpserver; do
 sudo systemctl stop $i 2>/dev/null || true
 sudo systemctl disable $i 2>/dev/null || true
done

# Install the package
sudo python3 -m pip install . --break-system-packages

# Install systemd service
sudo cp systemd/sigmatcpserver.service /lib/systemd/system/
sudo systemctl daemon-reload
sudo mkdir -p /var/lib/hifiberry

LOC=`which dsptoolkit`
sudo mkdir ~/.dsptoolkit

# Start and enable the service
for i in sigmatcpserver; do
 sudo systemctl start $i
 sudo systemctl enable $i
done

cat /boot/config.txt | grep -v "dtparam=spi" >> /tmp/config.txt
echo "dtparam=spi=on" >> /tmp/config.txt
sudo mv /tmp/config.txt /boot/config.txt
